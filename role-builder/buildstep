#!/bin/bash
set -eo pipefail
shopt -s nullglob

REPO="$1"; BRANCH="$2"; IMAGE="$3"; CMD="$4"; IMAGE_NAME="$REPO/$BRANCH"

id=$(cat | docker run -i -a stdin $IMAGE /bin/bash -c "mkdir -p /app && tar -xC /app")
test "$(docker wait $id)" -eq 0
docker commit $id $IMAGE_NAME > /dev/null

if [[ $CMD ]]; then
	id=$(docker run -d $IMAGE_NAME $CMD)
	docker attach $id
	test "$(docker wait $id)" -eq 0
	docker commit $id $IMAGE_NAME > /dev/null
fi
